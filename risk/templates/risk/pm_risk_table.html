{% extends "risk/base.html" %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@16.2.0/dist/handsontable.full.min.css" />
{% endblock %}

{% block content %}
    <div style="margin-bottom:1em">
        <label for="risk_date">Select Date:</label>
        <input type="date" id="risk-date" name="risk-date" value="{{ today }}">
        
        <button class="btn" id="copy-to-today-btn">
            Copy To Today
            <span id="copy-indicator" style="display: none;">Copying...</span>
        </button>
    </div>
    <div id="pm-risk-table"></div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/handsontable@16.2.0/dist/handsontable.full.min.js"></script>  
    <script>
        const container = document.querySelector('#pm-risk-table');
        const hot = new Handsontable(container, {
            themeName: 'ht-theme-main-dark-auto',
            columns: [
                { data: 'book', title: 'Book' },
                { data: 'risk', title: 'Risk' },
                { data: 'target', title: 'Target' },
                { data: 'stop', title: 'Stop' },
                { data: 'worst_case_bp', title: 'Worst Case (bp)' },
                { data: 'worst_case_k', title: 'Worst Case (k)' },
                { data: 'comment', title: 'Comment on stress estimation' }
            ],       
            data: [],
            rowHeaders: true,
            colHeaders: true,
            height: 'auto',
            copyPaste: true,
            licenseKey: 'non-commercial-and-evaluation'
        });


        function updateRiskTable(data) {
            hot.loadData(data)
        }

        // Function to load risk data
        async function loadRiskData(selectedDate = null) {
            const url = new URL("{% url 'daily_risk_data' %}", window.location.origin);

            if (selectedDate) {
                url.searchParams.set("date", selectedDate);
            }
        
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                updateRiskTable(data);
            } catch (error) {
                console.error('Error loading risk data:', error);
                alert('Failed to load risk data. Please try again later.');
            }
        }


        // Function to copy to today
        async function copyToToday() {
            const button = document.getElementById('copy-to-today-btn');
        
            button.disabled = true;
        
            try {
                const response = await fetch("{% url 'copy_to_today' %}");
                const result = await response.json();
                if (Array.isArray(result.entries) && result.entries.length > 0) {
                    // Update date input and reload result
                    
                    dateInput = document.getElementById('risk-date')
                    dateInput.value = result.date;
                    updateRiskTable(result.entries);
                } else {
                    alert("No data from yesterday")
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Failed to load data: ' + error.message);
            } finally {
                button.disabled = false;
            }
        }
        
        // Event listeners
        document.getElementById('risk-date').addEventListener('change', function() {
            loadRiskData(this.value);
        });
        
        document.getElementById('copy-to-today-btn').addEventListener('click', copyToToday);
        
        // Load initial data    
        loadRiskData("{{ today }}");
    </script>
{% endblock %}